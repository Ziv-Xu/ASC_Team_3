# 第二周基准测试学习汇总

## 第一部分：HPL (High-Performance Linpack)

### 1.1 HPL 的目标

HPL（High-Performance Linpack）是衡量超级计算机浮点计算性能的基准测试程序。它通过求解稠密线性方程组（Ax=b）来评估系统的**理论峰值性能**，是TOP500超级计算机排行榜的官方基准测试。

**主要特点**：
- 测试系统在密集线性代数计算中的最大性能
- 使用双精度浮点运算（64位）
- 主要依赖CPU计算能力和内存带宽
- 通信模式规整、可预测

### 1.2 HPL 的输出

#### 典型输出示例：
```
================================================================================
T/V                N    NB     P     Q               Time                 Gflops
--------------------------------------------------------------------------------
WR00L2L4        1000   128     1     1               0.01             6.9454e+01
--------------------------------------------------------------------------------
```

#### 输出字段解析：

| 字段 | 含义 | 说明 |
|------|------|------|
| **T/V** | 测试类型 | 表示测试的变体，如WR00L2L4、WR11C2R4等 |
| **N** | 问题规模 | 线性方程组的矩阵维度（N×N），影响内存使用量和计算量 |
| **NB** | 分块大小 | 矩阵分块的尺寸，影响缓存利用率和并行效率 |
| **P×Q** | 进程网格 | MPI进程的二维分布（P行×Q列），P×Q=总进程数 |
| **Time** | 计算时间 | 求解线性方程组的实际计算时间（秒） |
| **Gflops** | 性能指标 | **每秒十亿次浮点运算**，是核心性能指标 |

### 1.3 HPL 性能指标

#### **关键性能指标：Gflops**
- **计算公式**：Gflops = (2/3 × N³ + 2 × N²) / (Time × 10⁹)
- **意义**：值越大代表系统浮点计算能力越强
- **参考标准**：
  - 单核CPU：几到几十Gflops
  - 多核CPU/单个节点：几百到几千Gflops
  - 超级计算机：Pflops级别（10¹⁵次运算/秒）

#### **性能影响因素**：
1. **硬件因素**：
   - CPU主频和核心数
   - 内存带宽和延迟
   - 缓存层级结构
   - NUMA架构优化

2. **软件配置**：
   - BLAS库优化
   - MPI实现和通信优化
   - 编译器优化选项

3. **参数设置**：
   - N的选择（足够大以体现性能，但不能超出内存）
   - NB的优化（匹配缓存大小）
   - P×Q网格布局（匹配网络拓扑）



## 第二部分：HPCG (High-Performance Conjugate Gradient)

### 2.1 HPCG 的目标

HPCG（High-Performance Conjugate Gradient）是衡量超级计算机在实际科学计算应用中性能的基准测试。它模拟了**稀疏矩阵迭代求解**问题，更接近真实科学计算应用的特征。

**与HPL的主要区别**：
- HPL：密集、规则计算 → 测**理论峰值**
- HPCG：稀疏、不规则计算 → 测**实际应用性能**

### 2.2 HPCG 的选项和参数
```
mpirun [MPI选项] ./xhpcg [参数]
```
#### 选项
- -np <n> :指定MPI进程数
- --hostfile <file\> :指定主机文件
- --bind-to core :将进程绑定到核心
- --map-by core :按核心映射进程

#### 参数
- 无参数：使用默认的hpcg.dat输入文件
- <nx\><ny\><nz\> :制定问题规模的三个维度
- --rt=<seconds\> :指定运行时间（秒）
#### 输入文件hpcg.dat的理解
- 简单来说，这个文件是 HPCG（High Performance Conjugate Gradients）基准测试程序 的核心配置文件，用来定义测试的参数、规模和运行规则，HPCG 程序会读取这个文件的内容来执行对应的性能测试
- 个人理解：hpcg相当于一个默认值库，HPCG读取参数时：命令行显式指定的参数 → hpcg.dat 文件里的参数 → 报错（无可用参数）

### 2.3 HPCG 的输出

#### 典型输出示例：
```
====== Summary ======
...
HPCG result is **VALID** with a GFLOP/s rating of: **15.8**
HPCG 2.4 rating for historical comparison is: 15.8
...
```

#### 关键输出字段：

1. **有效性验证**：
   ```
   HPCG result is VALID
   ```
   - 必须看到"VALID"才表示测试结果有效
   - 如果显示"INVALID"，需要检查配置或硬件问题

2. **性能指标**：
   ```
   GFLOP/s rating of: 15.8
   ```
   - 核心性能指标，单位也是Gflop/s
   - 注意：HPCG的Gflop/s值通常比HPL小很多

3. **详细性能分解**：
   ```
   Data for 1 MPI task(s) and 4 OpenMP thread(s) per task
   ==== Double precision ====
   Reference time: 296.32
   Optimized time: 29.64
   Speedup: 10.0
   ```
   - 显示参考实现与优化实现的对比
   - 可以分析各部分的性能提升

### 2.4 HPCG 性能指标分析

#### **性能组成分析**：
HPCG测试包含多个计算内核，性能受以下因素影响：

1. **计算内核**：
   - 稀疏矩阵-向量乘（SpMV）
   - 向量点积
   - 预处理共轭梯度

2. **内存访问模式**：
   - 不规则内存访问
   - 缓存命中率
   - 内存带宽利用率

3. **通信开销**：
   - 邻居通信模式
   - 通信延迟敏感
   - 通信与计算重叠

#### **HPCG与HPL性能对比特点**：
```
系统配置：双路Xeon Gold 6248（共40核）
┌──────────────┬─────────────┬──────────────┐
│ 测试类型     │ 性能值      │ 与峰值比     │
├──────────────┼─────────────┼──────────────┤
│ 理论峰值     │ ~2000 Gflops│ 100%         │
│ HPL实测      │ ~1500 Gflops│ 75%          │
│ HPCG实测     │ ~100 Gflops │ 5%           │
└──────────────┴─────────────┴──────────────┘
```

**典型比例关系**：HPCG性能通常为HPL性能的1-10%

#### **性能优化重点**：
1. **内存层次优化**：
   ```bash
   # 提高缓存利用率
   export OMP_PROC_BIND=true
   export OMP_PLACES=cores
   ```

2. **通信优化**：
   ```bash
   # 优化MPI通信
   mpirun --map-by core --bind-to core ./xhpcg
   ```

3. **负载均衡**：
   - 均匀分布非零元素
   - 优化邻居进程通信

## 第三部分：HPL与HPCG在超算竞赛中的作用和意义

### 3.1 两种基准测试的核心差异对比

| 维度 | HPL (Linpack) | HPCG (Conjugate Gradient) |
|------|---------------|----------------------------|
| **测试目标** | 理论峰值性能 | 实际应用性能 |
| **计算类型** | 密集线性代数 | 稀疏矩阵迭代 |
| **内存访问** | 规则、连续 | 不规则、间接 |
| **通信模式** | 规整、全局 | 局部、邻居 |
| **瓶颈部位** | CPU计算单元<br>内存带宽 | 内存延迟<br>通信开销<br>缓存效率 |
| **性能数值** | 高（接近峰值） | 低（峰值的1-10%） |
| **优化重点** | 极致计算优化 | 系统平衡优化 |

### 3.2 在超算竞赛中的具体作用

#### **HPL在竞赛中的作用**：

1. **基础性能标定**：
   ```text
   作用：建立系统性能基线
   意义：了解硬件极限能力
   竞赛价值：决定基础得分和排名
   ```

2. **硬件调优验证**：
   - 验证CPU频率、内存带宽优化效果
   - 测试不同数学库（MKL/OpenBLAS）的性能差异
   - 优化MPI通信参数和进程绑定

3. **资源分配依据**：
   ```text
   通过HPL测试可以确定：
   - 每个节点的最佳进程数
   - 最优的P×Q进程网格
   - 适合的问题规模(N)
   ```

#### **HPCG在竞赛中的作用**：

1. **应用性能预测**：
   ```text
   HPCG性能 ≈ 实际科学应用性能
   例如：计算流体力学、分子动力学等应用
   ```

2. **系统平衡性检验**：
   - 检验内存子系统效率
   - 评估通信网络性能
   - 验证系统整体平衡性

3. **优化策略验证**：
   ```text
   成功的HPCG优化通常意味着：
   1. 良好的内存访问模式
   2. 高效的通信重叠
   3. 合理的负载均衡
   这些技能可直接应用于竞赛应用优化
   ```
